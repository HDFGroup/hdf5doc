<html>
<head>
<title>Metadata Journaling and File Recovery</title>
</head>
<body>


<!-- NEW PAGE -->
<!-- HEADER RIGHT "Metadata Journaling and File Recovery" -->

<h2>Using HDF5&rsquo;s Metadata Journaling and File Recovery Features</h2>
                                                <div align=right>
                                                <font color=999999 size=-1><i>
                                                Last modified: 5 January 2012
                                                </i></font></div>

  <h3>Overview</h3>
  <dir>
      The HDF5 metadata journaling and file recovery feature set guards
      against metadata corruption and provides a recovery capability.
      This document provides basic instructions for using these features,
      with a few examples along the way.

  </dir>
  <h3>Motivation</h3>
  <dir>
      The combination of metadata journaling and file recovery 
      enables metadata recovery in the case of metadata corruption.
      In many cases, it will be possible to recover cleanly from 
      such a failure. 
      <p>
<!--
      <p>
      HDF5 Library functions govern metadata journaling:
      <ul>
          <li><a href="../RM/H5Fset_jnl_config.html">
              <code>H5Fset_jnl_config</code></a> 
          <li><a href="../RM/H5Fget_jnl_config.html">
              <code>H5Fget_jnl_config</code></a> 
          <li><a href="../RM/H5Pset_jnl_config.html">
              <code>H5Pset_jnl_config</code></a>
          <li><a href="../RM/H5Pget_jnl_config.html">
              <code>H5Pget_jnl_config</code></a> 
      </ul>
      <p>
      If a system crash or similar event subsequently
      results in abandoning a file without properly closing it,
      leaving the file in a corrupted state, 
      a scriptable command-line tool can use that journal record to 
      bring the metadta up-to-date:
      <ul>
          <li><a href="../RM/h5recover.html"><code>h5recover</code></a> 
      </ul>
-->
      When metadata journaling is turned on for an HDF5 file, 
      all metadata written to that file is also written to a journal log file.  
      If a system crash, file system failure, or other event causes 
      the application to terminate unexpectedly and abandon the HDF5 file
      without properly closing it, the scriptable command line tool 
      <code>h5recover</code> can use the entries in the metadata journal 
      log file to reapply missing metadata to the HDF5 file. 
      <p>
      Note that this feature set preserves only metadata; different 
      steps must be taken to guard against raw data loss or corruption.
      For example, 
      <a href="http:/www.hdfgroup.org/HDF5/doc/RM/RM_H5F.html#File-Flush">
      <code>H5Fflush</code></a>
      can reduce the delay between processing data and writing it to the file.
      

  </dir>
  <h3>Metadata journaling usage</h3>
  <dir>
      Metadata journaling is for situations where 
      a file is vulnerable to loss in a &ldquo;crash&rdquo; situation.
      Using a file access property list, a file can be opened with or without 
      metadata journaling enabled;
      using HDF5 calls on an active file, metadata journaling can be 
      turned on or off for an open file.
<!-- STILL NOT HAPPY WITH THE ABOVE PARAGRAPH.  FMB -->

      <p>
  <b>Journaling by property list</b> 
  <br>
      <a href="../RM/H5Pset_jnl_config.html"><code>H5Pset_jnl_config</code></a>
      sets up the metadata journaling configuration in 
      a file access property list.  
      Using this property list, a file can be opened with metadata journaling
      already configured and running; journaling will keep running until
      it is turned off with 
      <a href="../RM/H5Fset_jnl_config.html"><code>H5Fset_jnl_config</code></a>,
      the file is closed, 
      or a crash occurs.
      <p>
      <a href="../RM/H5Pget_jnl_config.html"><code>H5Pget_jnl_config</code></a>
      retrieves the metadata journaling configuration from the file access
      property list.

      <p>
  <b>Journaling on an open file</b> 
  <br>
      By its nature, metadata journaling slows an HDF5 application 
      to some degree.  It is common, therefore, to turn journaling on 
      only at times when the file is particularly vulnerable to metadata loss.
      <p>
      Use 
      <a href="../RM/H5Fset_jnl_config.html"><code>H5Fset_jnl_config</code></a> 
      to turn metadata journaling on and off for an open file, 
      turning it on when the file is thought to be vulnerable
      and off when it is safe to do so.
      When it is safe, the application can run at full speed;
      application processing will slow only when journaling is most necessary.
      <p>
      <a href="../RM/H5Fget_jnl_config.html"><code>H5Fget_jnl_config</code></a> 
      retrieves the current metadata journaling configuration for 
      the open file.
      <p>
      Note that starting metadata journaling on an already-open file
      first flushes the metadata cache so that journaling can start with 
      a clean slate.
      Such a cache flush can result in significant I/O; there may be
      a corresponding pause in application processing.

      <p>
  <b>Combined usage</b> 
  <br>
      The file (H5F) and property list (H5P) functions can be used 
      in combination.
      For example, metadata journaling can be set up in a property list
      with <code>H5Pset_jnl_config</code> and a file opened with that
      property list.
      Metadata journaling can run for as long as it is needed,
      then turned off and back on repeatedly with 
      <code>H5Fset_jnl_config</code>.

  </dir>
  <h3>Use of a file while metadata journaling is on</h3>
  <dir>
      While metadata journaling is turned on, an HDF5 file can be used in 
      all of the usual ways.  
          Data can be written to the file, 
          its structure can be modified,
          data can be processed and rewritten, 
          <cite>et cetera</cite>.
      <p>
      Every time metadata is written to the file, that write enters 
      the metadata cache and a corresponding entry is written to the 
      designated metadata journal log file.
      Periodically, the metadata cache is flushed to the file;
      when this flush succeeds, the journal log entries corresponding to 
      all metadata entries successfully written to the file are removed 
      from the journal log file.

  </dir>
  <h3>File recovery</h3>
  <dir>
      If the file is subsequently closed properly, 
      with all metadata flushed to the file, 
      the metadata journal log file will be empty.
      <p>
      But if a system crash or similar event 
      results in abandoning a file without properly closing it,
      the file will almost certainly be in a corrupted state. 
      If metadata journaling was running when that crash occurred, 
      the scriptable command-line tool 
      <a href="../RM/h5recover.html"><code>h5recover</code></a> 
      can use the metadata journal record to recover the lost cached metadata,
      applying the metadata records that remained in the journal log file.
      <p>
      For example, in the context of the 
      <a href="../examples/enable_journaling.c"><code>enable_journaling.c</code></a>
      example below, the following <code>h5recover</code> call from the 
      command line or from a script would apply the journal log entries
      from the log file <code>JournalEG.h5.jnl</code> to repair the
      the corrupted file <code>JournalEG.h5</code>:
      <pre>
            h5recover -j JournalEG.h5.jnl JournalEG.h5 
      </pre>
      <p>
      In the general case, the HDF5 file will then be usable, 
      though other factors will determine whether the raw data 
      is in sync with the metadata.

<!-- NEED REFERENCE TO STRATEGIES TO ENSURE THE INTEGRITY OF RAW DATA. -->
<!-- SO FAR, ONLY H5Fflush HAS BEEN MENTIONED.   FMB                   -->

  </dir>
  <h3>Example 1: Metadata journaling with HDF5</h3>
  <dir>

<div align="right"><font color="red"><i>
(Consider embedding relevant snippets of code<br>
in this and the following examples.)
</i></font></div>

      The C example in the file
      <a href="../examples/enable_journaling1.c"><code>enable_journaling1.c</code></a>
      demonstrates enabling metadata journaling at file creation time 
      and enabling journaling on an open file.  
      It also demonstrates disabling metadata journaling both manually 
      during a computation and automatically at file close.  
      Finally, the example demonstrates the use of 
      <a href="http://www.hdfgroup.org/HDF5/doc/RM/RM_H5F.html#File-Flush">
      <code>H5Fflush</code></a> 
      to keep the journal file from becoming too large.
      <p>
      The example  begins by creating an HDF5 file with journaling enabled.
      The paths to the HDF5 and journal files are passed in, so the only point 
      to consider is whether the journal file already exists, as HDF5 will 
      refuse to overwrite it if it does.  This example removes any pre-existing
      journal file unconditionally, but you will probably wish to do otherwise 
      in your application.
      <p>
      With these preliminaries dealt with, the example allocates a 
      file access property list (FAPL).  Journaling uses recent extensions 
      to the superblock, so the first step is to call 
      <a href="http://www.hdfgroup.org/HDF5/doc/RM/RM_H5P.html#Property-SetLibverBounds">
      <code>H5Pset_libver_bounds</code></a>
      to specify using the latest version of the HDF5 file format.

<!-- EDITORIAL COMMENT: THE ABOVE STATEMENT IS PRESUMABLY VALID ONLY UNTIL -->
<!-- RELEASE 1.10, AT WHICH POINT THE OPTION SHOULD BE AVAILABLE TO      -->
<!-- "SPECIFY USING A SPECIFIED MINIMUM VERSION OF THE LIBRARY",         -->
<!-- I.E., "SPECIFY A FORMAT VERSION NO OLDER THAN..."                   -->

<div align="right"><font color="red"><i>
(Editorial comment: The above statement is presumably valid<br>
only until Release 1.10, at which point the option should be<br>
available to "specify using a specified minimum version of the<br>
HDF5 Library", i.e., "specify a format version no older than...")
</i></font></div>

      <p>
      The example next sets up the metadata journaling property.  
      We could do this in several ways, but this example uses
      <a href="../RM/H5Pget_jnl_config.html"><code>H5Pget_jnl_config</code></a> 
      to get the default journaling configuration, 
      modifies that configuration as needed, 
      and then uses 
      <a href="../RM/H5Pset_jnl_config.html"><code>H5Pset_jnl_config</code></a> 
      to replace the default journaling configuration with our own.  
      See the comments in the code for the particulars, noting that 
      we must set the version field of the 
      <a href="../RM/H5AC_jnl_config_t.html"><code>H5AC2_jnl_config_t</code></a>
      struct before calling <code>H5Pget_jnl_config</code>.
      <p>
      After setting up the FAPL, this example creates the file as usual.
      Since the FAPL calls for metadata journaling, journaling will be enabled 
      on this file.

<div align="right"><font color="red"><i>
(Editorial comment: Not just "create";
<br>we might also want an "open".)
</i></font></div>

      <p>
      With the file created and journaling running, we can then go off 
      and do what we want; this is where application computation occurs. 
      This example sets up a selection of chunked datasets.  
      Note that these datasets (and the later access pattern) 
      are chosen to maximize the amount of dirty metadata generated.  
      This is done deliberately to exercise the metadata journaling features.  
      Your application will presumably be structured quite differently.
      <p>
      After the datasets are created, journaling is shut down and
      re-started via 
          <a href="../RM/H5Fget_jnl_config.html">
          <code>H5Fget_jnl_config</code></a> 
      and 
          <a href="../RM/H5Fset_jnl_config.html">
          <code>H5Fset_jnl_config</code></a>
      calls.  Note that when re-enabling journaling via the 
      <code>H5Fset_jnl_config</code> call, not all of the fields 
      in the <code>H5AC2_jnl_config_t</code> struct need to be reset; 
      the configuration obtained via the original 
      <code>H5Fget_jnl_config</code> call is re-used.  
      (If we had originally opened the file without journaling and
      then wanted to enable journaling, we would have to set up the
      fields of the <code>H5AC2_jnl_config_t</code> struct in much the same way 
      we did earlier in this example.  We would also have had to use
      <code>H5Pset_libver_bounds</code> to set the FAPL to create the file 
      initially with the latest HDF5 file format format.) 

<div align="right"><font color="red"><i>
(Editorial comment: Find more appropriate 
<br>location for "(If we had originally...)")
</i></font></div>

      <p>
      Having re-enabled journaling, the example then proceeds to write to 
      the datasets.  Again, please note that the write strategy in this 
      example (round robin and small chunks) is designed to maximize
      dirty metadata generation and to exercise the metadata cache.
      When possible, real applications designed for efficient operation
      usually do just the opposite.
      <p>
      This example maximizes dirty metadata generation deliberately to force
      the journal file will grow quickly, setting up the next illustration.  
      Large journal files can be a problem, so from time to time it may
      be necessary to force truncation of the journal file via a call to 
      <code>H5Fflush</code>.  This call flushes the HDF5 file then truncates 
      the journal file, as the content of the journal becomes irrelevant 
      after the metadata journal is flushed.
      <p>
      After writing data to the datasets, the example then does a number of 
      reads.  We could turn off journaling here, as we are not modifying the 
      file.  But neither are we generating dirty metadata or journal entries,
      so there is no cost to keep journaling running.
      <p>
      Finally, the example closes the HDF5 file.  Since journaling is enabled,
      the call to 
      <a href="http://www.hdfgroup.org/HDF5/doc/RM/RM_H5F.html#File-Close">
      <code>H5Fclose</code></a> 
      will flush the journal, flush the metadata cache, truncate the journal, 
      mark the file as not having journaling in progress, 
      and then delete the journal file as part of the close.
      <p>
      This example may run for several minutes.  If you are 
      interested in observing the example's behavior (or if you are
      just bored), run <code>'ls -l'</code> every few seconds in the directory 
      containing the journal file; you will be able to watch the 
      journal file grow, see when it is truncated as the file is 
      flushed, and watch it grow again.  This cycle is repeated many 
      times through the course of the example.

  </dir>
  <h3>Example 2: Metadata journaling with HDF5 and file recovery</h3>
  <dir>
      The example in
      <a href="../examples/enable_journaling.c"><code>enable_journaling.c</code></a>
      illustrates the use of metadata journaling to log metadata updates 
      in an HDF5 file, an interuption that forces abandonment of the file
      without properly closing it, and restoration of the metadate entries 
      lost as a result of the interuption.
      <p>
      In this example, the application 
      sets up metadata journaling in a file access property list, 
      opens the HDF5 file <code>JournalEG.h5</code> with that property list 
      so that metadata journaling is turned on with the journal log entries 
      being recorded in <code>JournalEG.h5.jnl</code>, 
      and performs a series of operations on the file.
      <p>
      The example includes instructions for interupting the program,
      usually leaving <code>JournalEG.h5</code> in a corrupted state.
      The corrupted file can then be recovered with the following 
      <code>h5recover</code> call:
      <pre>
            h5recover -j JournalEG.h5.jnl JournalEG.h5 
      </pre>

  </dir>
  <h3>Example 3: Metadata journaling with netCDF-4 and file recovery</h3>
  <dir>
      NetCDF-4 employs a single function, 
      <code>nc_set_metadata_journaling()</code>,
      to control metadata journaling.
      The example files 
      <a href="../examples/nc4_norecover.c"><code>nc4_norecover.c</code></a>
      and 
      <a href="../examples/nc4_recover.c"><code>nc4_recover.c</code></a>
      demonstrate the simple code additions required to use this function
      to enable HDF5 metadata journaling for data files;  
      the code in these files is identical except 
      for the names of the output data files and 
      the fact that <code>nc4_recover.c</code> includes a call to 
      <code>nc_set_metadata_journaling</code>
      and the setup that that function requires.
      Running the examples will produce two files:
      <code>nc4_recover.c</code> produces <code>recover.nc</code> and
      <code>nc4_norecover.c</code> produces <code>norecover.nc</code>.  
      <p>
      Both example codes generate an interrupt that causes the output files 
      to be corrupted, so running the netCDF-4 utility <code>ncdump</code> 
      on these files will result in an error.  
      But since <code>nc4_recover.c</code> employs metadata journaling, 
      the data in the file <code>recover.nc</code> can be recovered 
      with the use of the HDF5 utility <code>h5recover</code> as follows:
      <pre>    h5recover -j recover.jnl recover.nc </pre>
      <code>nc4_norecover.c</code> does not employ metadata journaling,
      so the file <code>norecover.nc</code> cannot be recovered.
      <p>
      HDF5 does not journal raw data; therefore raw data consistency 
      is unknown if a file is open when a machine crash occurs.  
      But these example files illustrate one method of using 
      journaled metadata to track the certainty of consistent raw data 
      in an application which only appends data, 
      never changing previously written data.  
      The examples write four arrays of 32768 rows of 16 integers 
      to a dataset in the test file, considering each of these arrays 
      to be a consistent set of data if and only if it is complete.
      <p>
      The procedure for tracking data in the example is to write one of 
      the arrays, sync the test file, write the iteration number to 
      an attribute named <code>DataLastUpdated</code>, 
      and sync the test file again to flush the current attribute value 
      to disk.  The example data consists of rows of consecutive integers 
      beginning with the iteration number at the beginning of 
      row 0 and consecutively higher integers to begin each row 
      and across each row, as illustrated.  
      <pre>        1 2 3 ... 16
        2 3 4 ... 17
        3 4 5 ... 18
          .
          .
          .
        32767 32768 32769 ... 32782
        32768 32769 32770 ... 32783 </pre>
      <p>
      Four arrays of consecutive integers will be present 
      in the recovered file: 
      the first three arrays will contain the integers
          0 through 131086, 
          1 through 131087, and
          2 through 131088, respectively;
      the fourth array will contain the integers
          3 through 98321 followed by 524288 fill values.  
      These arrays can be conveniently viewed by running this command
      <pre>    &lt;path to ncdump&gt;/ncdump recover.nc | more </pre>
      then searching for the largest number of each successive array 
      (e.g. /131086).
      <p>
      The fill values are present in the fourth array 
      because that array of data is not synced to disk 
      before terminating the program.  
      Since some of the data written to the file is flushed 
      when the cache reaches its capacity, approximately three-fourths 
      of the fourth array is present on disk.  
      The <code>DataLastUpdated</code> attribute at the beginning 
      of the file should have a value of 2, indicating that the 
      third array was completely synced to disk, and that the 
      fourth array was not completely written to disk 
      and should therefore be entirely disregarded.  
      <p>
      For real data, the tracking attribute should be assigned a value 
      that corresponds to a unique value identifying the 
      most recently written collection of data.  
      The key to accurately tracking the raw data is to write 
      the value associated with the recently written and 
      completely synced raw data to the tracking attribute, 
      followed by another sync of the file to ensure that 
      the updated attribute value is written to disk.  
      This last sync avoids discarding data that could not be validated 
      if the program crashes after writing the attribute value 
      but before the next sync of the file occurs.



  </dir>
  <h3>See also</h3>
  <dir>
    <table border=0>
      <tr valign="top"><td>
          Reference&nbsp;manual
      </td><td>&nbsp;&nbsp;&nbsp;&nbsp;</td><td>
          <a href="../RM/H5Fset_jnl_config.html">
          <code>H5Fset_jnl_config</code></a>,
          &nbsp;
          <a href="../RM/H5Fget_jnl_config.html">
          <code>H5Fget_jnl_config</code></a>, 
          &nbsp;
          <a href="../RM/H5Pset_jnl_config.html">
          <code>H5Pset_jnl_config</code></a>, 
          &nbsp;
          <a href="../RM/H5Pget_jnl_config.html">
          <code>H5Pget_jnl_config</code></a> 
          <p>
          <a href="../RM/H5AC_jnl_config_t.html">
          <code>H5AC_jnl_config_t</code></a>
          <p>
          <a href="../RM/h5recover.html"><code>h5recover</code></a>
          <p>
      
<!--
      </td></tr><tr valign=top><td>
          <p>
          Usage
          <p>
      </td><td>&nbsp;</td><td>
          <p>
          &ldquo;<a href="../RG/CrashSurvival.html">Using HDF5&rsquo;s 
          Metadata Journaling and File Recovery Features</a>&rdquo;
          <p>
-->

      </td></tr><tr valign=top><td>
          <p>
          Code&nbsp;examples
          <p>
      </td><td>&nbsp;</td><td>
          <p>
          <a href="../examples/enable_journaling1.c"><code>enable_journaling1.c</code></a>
          <br>
          <a href="../examples/enable_journaling.c"><code>enable_journaling.c</code></a>
          <br>
          <a href="../examples/nc4_recover.c"><code>nc4_recover.c</code></a>
          <br>
          <a href="../examples/nc4_norecover.c"><code>nc4_norecover.c</code></a>
          <p>

      </td></tr><tr valign=top><td>
          <p>
          Design
      </td><td>&nbsp;</td><td>
          <p>
          &ldquo;<a href="../RG/Metadata_Journaling,Crash_Survivability.pdf">Metadata
          Journaling to Improve Crash Survivability</a>&rdquo; 
          <p>

      </td></tr><tr valign=top><td>
          <p>
          Topic&nbsp;index
      </td><td>&nbsp;</td><td>
          <p>
          &ldquo;<a href="../index.html">Documentation for Metadata Journaling
          and File Recovery</a>&rdquo;
          <p>

      </td></tr><tr valign=top><td>
          <p>
          Related&nbsp;topic
      </td><td>&nbsp;</td><td>
          <p>
          &ldquo;<a href="../../MetadataCache/index.html">Metadata Caching 
          in HDF5</a>&rdquo;
          <p>

      </td></tr>
    </table>
  </dir>
      

</body>
</html>
