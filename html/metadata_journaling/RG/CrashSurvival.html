<html>
<head>
<title>Metadata Journaling and File Recovery</title>
</head>
<body>


<!-- NEW PAGE -->
<!-- HEADER RIGHT "Metadata Journaling and File Recovery" -->

<h2>Using HDF5&rsquo;s Metadata Journaling and File Recovery Features</h2>

  <h3>This document</h3>
  <dir>
      This document provides brief instructions for using the
      HDF5 metadata journaling and file recovery features.
      More complete instructional material is being prepared. 

  </dir>
  <h3>Motivation</h3>
  <dir>
      The metadata journaling and file recovery feature set
      enables metadata recovery in the case of metadata corruption.
      In many cases, it will be possible to recover cleanly from 
      such a failure. 
      <p>
<!--
      <p>
      HDF5 Library functions govern metadata journaling:
      <ul>
          <li><a href="../RM/H5Fset_jnl_config.html">
              <code>H5Fset_jnl_config</code></a> 
          <li><a href="../RM/H5Fget_jnl_config.html">
              <code>H5Fget_jnl_config</code></a> 
          <li><a href="../RM/H5Pset_jnl_config.html">
              <code>H5Pset_jnl_config</code></a>
          <li><a href="../RM/H5Pget_jnl_config.html">
              <code>H5Pget_jnl_config</code></a> 
      </ul>
      <p>
      If a system crash or similar event subsequently
      results in abandoning a file without properly closing it,
      leaving the file in a corrupted state, 
      a scriptable command-line tool can use that journal record to 
      bring the metadta up-to-date:
      <ul>
          <li><a href="../RM/h5recover.html"><code>h5recover</code></a> 
      </ul>
-->
      When metadata journaling is turned on, all metadata written to 
      an HDF5 file is also written to a journal log file.  
      If the application terminates in such a manner that the 
      HDF5 file is abandoned without being properly closed, 
      the command line tool <code>h5recover</code> can be used to 
      reapply missing metadata to the HDF5 file according to the entries 
      in the metadata journal log file.
      <p>
      Note that this feature set preserves only metadata; different 
      steps must be taken to guard against raw data loss or corruption.
      For example, 
      <a href="http:/www.hdfgroup.org/HDF5/doc/RM/RM_H5F.html#File-Flush">
      <code>H5Fflush</code></a>
      can reduce the delay between processing data and writing it to the file.
      

  </dir>
  <h3>Metadata journaling usage</h3>
  <dir>
      Metadata journaling is for situations where 
      a file is vulnerable to loss in a &ldquo;crash&rdquo; situation.

      <p>
  <b>Journaling by property list</b> 
  <br>
      <a href="../RM/H5Pset_jnl_config.html"><code>H5Pset_jnl_config</code></a>
      sets up the metadata journaling configuration in 
      a file access property list.  
      Using this property list, a file can be opened with metadata journaling
      already configured and running; journaling will keep running until
      it is turned off with 
      <a href="../RM/H5Fset_jnl_config.html"><code>H5Fset_jnl_config</code></a>,
      the file is closed, 
      or a crash occurs.
      <p>
      <a href="../RM/H5Pget_jnl_config.html"><code>H5Pget_jnl_config</code></a>
      retrieves the metadata journaling configuration from the file access
      property list.

      <p>
  <b>Journaling on an open file</b> 
  <br>
      By its nature, metadata journaling slows an HDF5 application 
      to some degree.  It is common, therefore, to turn journaling on 
      only at times when the file is particularly vulnerable to metadata loss.
      <p>
      Use 
      <a href="../RM/H5Fset_jnl_config.html"><code>H5Fset_jnl_config</code></a> 
      to turn metadata journaling on and off for an open file, 
      turning it on when the file is thought to be vulnerable
      and off when it is safe to do so.
      When it is safe, the application can run at full speed;
      application processing will slow only when journaling is most necessary.
      <p>
      <a href="../RM/H5Fget_jnl_config.html"><code>H5Fget_jnl_config</code></a> 
      retrieves the current metadata journaling configuration for 
      the open file.
      <p>
      Note that starting metadata journaling on an already-open file
      first flushes the metadata cache so that journaling can start with 
      a clean slate.
      Such a cache flush can result in significant I/O; there may be
      a corresponding pause in application processing.

      <p>
  <b>Combined usage</b> 
  <br>
      The file (H5F) and property list (H5P) functions can be used 
      in combination.
      For example, metadata journaling can be set up in a property list
      with <code>H5Pset_jnl_config</code> and a file opened with that
      property list.
      Metadata journaling can run for as long as it is needed,
      then turned off and back on repeatedly with 
      <code>H5Fset_jnl_config</code>.

  </dir>
  <h3>Use of a file while metadata journaling is &ldquo;on&rdquo;</h3>
  <dir>
      While metadata journaling is turned on, an HDF5 file can be used in 
      all of the usual ways.  
          Data can be written to the file, 
          its structure can be modified,
          data can be processed and rewritten, 
          <cite>et cetera</cite>.
      <p>
      Every time metadata is written to the file, that write enters 
      the metadata cache and a corresponding entry is written to the 
      designated metadata journal log file.
      Periodically, the metadata cache is flushed to the file;
      when this flush succeeds, the journal log entries corresponding to 
      all metadata entries successfully written to the file are removed 
      from the journal log file.

  </dir>
  <h3>File recovery</h3>
  <dir>
      If the file is subsequently closed properly, 
      with all metadata flushed to the file, 
      the metadata journal log file will be empty.
      <p>
      But if a system crash or similar event 
      results in abandoning a file without properly closing it,
      the file will almost certainly be in a corrupted state. 
      If metadata journaling was running when that crash occurred, 
      the scriptable command-line tool 
      <a href="../RM/h5recover.html"><code>h5recover</code></a> 
      can use the metadata journal record to recover the lost cached metadata,
      applying the metadata records that remained in the journal log file.
      <p>
      In the general case, the HDF5 file will then be usable, 
      though other factors will determine whether the raw data 
      is in sync with the metadata.

  </dir>
  <h3>Example: Opening a file with metadata journaling &ldquo;on&rdquo;</h3>
  <dir>
      The file 
      <a href="../examples/enable_journaling.c"><code>enable_journaling.c</a>
      illustrates the use of metadata journaling to log metadata updates 
      in a file.
      <p>
      In this example, the application sets up metadata journaling in 
      a file access property list, opens an HDF5 file with that property list
      so that metadata journaling is turned on, and performs a series of
      operations on the file.


  </dir>
  <h3>See also</h3>
  <dir>
    <table border=0>
      <tr valign="top"><td>
          Reference
      </td><td>&nbsp;&nbsp;&nbsp;&nbsp;</td><td>
          <a href="../RM/H5Fset_jnl_config.html">
          <code>H5Fset_jnl_config</code></a>,
          &nbsp;
          <a href="../RM/H5Fget_jnl_config.html">
          <code>H5Fget_jnl_config</code></a>, 
          &nbsp;
          <a href="../RM/H5Pset_jnl_config.html">
          <code>H5Pset_jnl_config</code></a>, 
          &nbsp;
          <a href="../RM/H5Pget_jnl_config.html">
          <code>H5Pget_jnl_config</code></a> 
          <p>
          <a href="../RM/H5AC_jnl_config_t.html">
          <code>H5AC_jnl_config_t</code></a>
          <p>
          <a href="../RM/h5recover.html"><code>h5recover</code></a>
          <p>
      
      </td></tr><tr valign=top><td>
          <p>
          Usage
          <p>
      </td><td>&nbsp;</td><td>
          <p>
          &ldquo;<a href="../RG/CrashSurvival.html">Using HDF5&rsquo;s 
          Metadata Journaling and File Recovery Features</a>&rdquo;
          <p>

      </td></tr><tr valign=top><td>
          <p>
          Examples
          <p>
      </td><td>&nbsp;</td><td>
          <p>
          <a href="../examples/enable_journaling.c"><code>enable_journaling.c</a>
          <p>

      </td></tr><tr valign=top><td>
          <p>
          Design
      </td><td>&nbsp;</td><td>
          <p>
          &ldquo;<a href="../RG/Metadata_Journaling,Crash_Survivability.pdf">Metadata
          Journaling to Improve Crash Survivability</a>&rdquo; 
          <p>

      </td></tr><tr valign=top><td>
          <p>
          Document<br>&nbsp;&nbsp;&nbsp;&nbsp;index
      </td><td>&nbsp;</td><td>
          <p>
          <a href="../index.html">Index of metadata journaling
          and crash survival documentation</a>
          <p>
 
      </td></tr>
    </table>
  </dir>
      

</body>
</html>
