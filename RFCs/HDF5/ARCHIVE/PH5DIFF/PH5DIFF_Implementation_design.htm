<html xmlns:v="urn:schemas-microsoft-com:vml"
xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns="http://www.w3.org/TR/REC-html40">

<head>
<meta http-equiv=Content-Type content="text/html; charset=windows-1252">
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 10">
<meta name=Originator content="Microsoft Word 10">
<link rel=File-List href="PH5DIFF_Implementation_design_files/filelist.xml">
<title>Purpose</title>
<!--[if gte mso 9]><xml>
 <o:DocumentProperties>
  <o:Author>Albert Cheng</o:Author>
  <o:Template>Normal</o:Template>
  <o:LastAuthor>Albert Cheng</o:LastAuthor>
  <o:Revision>14</o:Revision>
  <o:TotalTime>312</o:TotalTime>
  <o:LastPrinted>2004-09-15T14:24:00Z</o:LastPrinted>
  <o:Created>2004-09-15T12:16:00Z</o:Created>
  <o:LastSaved>2004-12-15T15:27:00Z</o:LastSaved>
  <o:Pages>1</o:Pages>
  <o:Words>1433</o:Words>
  <o:Characters>8169</o:Characters>
  <o:Company>NCSA</o:Company>
  <o:Lines>68</o:Lines>
  <o:Paragraphs>19</o:Paragraphs>
  <o:CharactersWithSpaces>9583</o:CharactersWithSpaces>
  <o:Version>10.2625</o:Version>
 </o:DocumentProperties>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:Zoom>125</w:Zoom>
  <w:GrammarState>Clean</w:GrammarState>
  <w:Compatibility>
   <w:BreakWrappedTables/>
   <w:SnapToGridInCell/>
   <w:ApplyBreakingRules/>
   <w:WrapTextWithPunct/>
   <w:UseAsianBreakRules/>
   <w:UseFELayout/>
  </w:Compatibility>
  <w:BrowserLevel>MicrosoftInternetExplorer4</w:BrowserLevel>
 </w:WordDocument>
</xml><![endif]-->
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:SimSun;
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-alt:\5B8B\4F53;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 135135232 16 0 262145 0;}
@font-face
	{font-family:"\@SimSun";
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 135135232 16 0 262145 0;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-parent:"";
	margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:SimSun;}
h1
	{mso-style-next:Normal;
	margin-top:12.0pt;
	margin-right:0in;
	margin-bottom:3.0pt;
	margin-left:0in;
	mso-pagination:widow-orphan;
	page-break-after:avoid;
	mso-outline-level:1;
	font-size:16.0pt;
	font-family:Arial;
	mso-font-kerning:16.0pt;}
h2
	{mso-style-next:Normal;
	margin-top:12.0pt;
	margin-right:0in;
	margin-bottom:3.0pt;
	margin-left:0in;
	mso-pagination:widow-orphan;
	page-break-after:avoid;
	mso-outline-level:2;
	font-size:14.0pt;
	font-family:Arial;
	font-style:italic;}
p.MsoFootnoteText, li.MsoFootnoteText, div.MsoFootnoteText
	{mso-style-noshow:yes;
	margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:SimSun;}
span.MsoFootnoteReference
	{mso-style-noshow:yes;
	vertical-align:super;}
p.MsoPlainText, li.MsoPlainText, div.MsoPlainText
	{margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.0pt;
	font-family:"Courier New";
	mso-fareast-font-family:SimSun;}
span.GramE
	{mso-style-name:"";
	mso-gram-e:yes;}
@page Section1
	{size:8.5in 11.0in;
	margin:1.0in 1.25in 1.0in 1.25in;
	mso-header-margin:.5in;
	mso-footer-margin:.5in;
	mso-paper-source:0;}
div.Section1
	{page:Section1;}
-->
</style>
<!--[if gte mso 10]>
<style>
 /* Style Definitions */
 table.MsoNormalTable
	{mso-style-name:"Table Normal";
	mso-tstyle-rowband-size:0;
	mso-tstyle-colband-size:0;
	mso-style-noshow:yes;
	mso-style-parent:"";
	mso-padding-alt:0in 5.4pt 0in 5.4pt;
	mso-para-margin:0in;
	mso-para-margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.0pt;
	font-family:"Times New Roman";}
</style>
<![endif]--><!--[if gte mso 9]><xml>
 <o:shapedefaults v:ext="edit" spidmax="6146"/>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <o:shapelayout v:ext="edit">
  <o:idmap v:ext="edit" data="1"/>
 </o:shapelayout></xml><![endif]-->
</head>

<body lang=EN-US style='tab-interval:.5in'>

<div class=Section1>

<h1 align=center style='text-align:center'>Implementation Design of the
Parallel HDF5 Diff Tool</h1>

<p class=MsoNormal align=center style='text-align:center'>(Revision: December
15, 2004 by Leon Arber, Albert Cheng)</p>

<h1>Purpose</h1>

<p class=MsoNormal>This presents the design to implement the Parallel HDF5 Diff
tool (ph5diff) in an MPI parallel environment.</p>

<h1>Overview</h1>

<p class=MsoNormal>We have chosen the Parallel Processing approach from the
initial design consideration<a style='mso-footnote-id:ftn1' href="#_ftn1"
name="_ftnref1" title=""><span class=MsoFootnoteReference><span
style='mso-special-character:footnote'><![if !supportFootnotes]><span
class=MsoFootnoteReference><span style='font-size:12.0pt;font-family:"Times New Roman";
mso-fareast-font-family:SimSun;mso-ansi-language:EN-US;mso-fareast-language:
ZH-CN;mso-bidi-language:AR-SA'>[1]</span></span><![endif]></span></span></a>.<span
style='mso-spacerun:yes'>  </span>The parallelization will come from doing
multiple datasets simultaneously, instead of splitting up a single dataset
among multiple tasks. <span class=GramE>ph5diff</span> will take two hdf5
files, find datasets common to both files, and then find the differences, if
any, in these datasets in both files.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>This is done by having two sets of tasks, a Manager task
(task 0) and Worker tasks (task 1...k).</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Worker tasks:</p>

<p class=MsoNormal>Given a dataset and the names of two hdf5 files, find the
differences in the corresponding dataset in the 2 files and report the
result.<span style='mso-spacerun:yes'>  </span>The dataset is guaranteed to
exist in both files.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Manager task:</p>

<p class=MsoNormal>Given two hdf5 files, walk through both files to generate a
list of datasets to compare.<span style='mso-spacerun:yes'>  </span>As soon as
a comparable dataset is identified, its name, along with the names of the two
files, is passed along to a Worker task for actual comparison.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<h1>Implementation details</h1>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<h2>Output</h2>

<p class=MsoNormal>The way h5diff is currently implemented, as soon as a
difference in two datasets is found, a print statement is executed.<span
style='mso-spacerun:yes'>  </span>Although this approach works well on a single
processor, with multiple processors this would result in a jumble of mismatched
outputs being printed to the screen and there would be no way to separate out
which differences belong to which dataset.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>To address this, an <i>Output Token </i>(OT) is being
introduced.<span style='mso-spacerun:yes'>  </span>A task can only print when
it has possession of the OT.<span style='mso-spacerun:yes'>  </span>The Manager
is the initial owner of the OT.<span style='mso-spacerun:yes'>  </span>When a
Worker task completes processing of a dataset and needs to print its output, it
requests the OT from the Manager.<span style='mso-spacerun:yes'>  </span>The Manager,
upon receipt of a request for printing, will pass the OT to that Worker
task.<span style='mso-spacerun:yes'>  </span>The Worker will then <span
class=GramE>print</span> and return the OT upon completion.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<h2>Further complications with output</h2>

<p class=MsoNormal>Since a difference in the two datasets causes a print
statement to be executed immediately, a task that does not have the OT will be
blocked until it has acquired it in order to print.<span
style='mso-spacerun:yes'>  </span>If a pair of files has numerous scattered
changes across multiple datasets, this will essentially cause ph5diff to run
serially as each Worker task waits for the OT instead of looking for the rest
of the differences in its dataset.<span style='mso-spacerun:yes'>  </span>A
Worker task will only continue looking for differences after it has obtained
the OT and printed the difference it was waiting to print.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>To address this, the original h5diff code will be modified
so <span class=GramE>that,</span> based on a compile-time parameter, a print
statement will either print immediately or buffer its output.<span
style='mso-spacerun:yes'>  </span>In the parallel case, this allows a Worker
task to continue processing the differences in a dataset after it finds the
first difference, as it will simply buffer the output instead of waiting for
the OT.<span style='mso-spacerun:yes'>  </span>When a Worker task finishes
processing a dataset, it will then wait for the OT to print its accumulated
list of differences.<span style='mso-spacerun:yes'>  </span>Once it gets the
token and prints its differences, it will notify the Manager that it is free
and can be assigned another dataset to compare.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The initial implementation will use a buffer of the size of
10KB.<span style='mso-spacerun:yes'>  </span>With the average of 50 characters
per line, the buffer will hold up to 200 lines of output. This size should work
well for files that are similar and have only a few differences on each
dataset.<span style='mso-spacerun:yes'>  </span>In the event that the pending
output exceeds the buffer capacity, the Worker task will immediately request
the OT for printing. The Worker is blocked until it has acquired the OT.<span
style='mso-spacerun:yes'>  </span>It then prints and compares the rest of the
dataset, printing as soon as it finds any differences.<span
style='mso-spacerun:yes'>  </span>When it has completed comparing the dataset,
it releases the OT back to the Manager and informs the Manager that it is free
for another dataset comparison.<span style='mso-spacerun:yes'>  </span>This
will serialize the Workers if the files have many differences on most
datasets.<span style='mso-spacerun:yes'>  </span>A command option is provided
for the user to specify a different buffer size such that a larger buffer size
can be used in anticipation of files of the preceding situation.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<h2>Scheduling of work</h2>

<p class=MsoNormal>Because some datasets might take longer to process than
others, there needs to be some scheduling system so that the Manager knows
which tasks are free and which are busy.<span style='mso-spacerun:yes'> 
</span>The Manager will maintain the state of all Worker tasks.<span
style='mso-spacerun:yes'>  </span>Initially, each Worker task will be free,
meaning ready to accept an assignment.<span style='mso-spacerun:yes'> 
</span>When the Manager finds a dataset that needs comparison, he will assign
it to the first free Worker task and mark that task as busy.<span
style='mso-spacerun:yes'>  </span>When the Worker task completes the dataset
and finishes printing the results, it will notify the Manager that it is free
again.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<h2>H5diff modes</h2>

<p class=MsoNormal>Non-verbose mode:</p>

<p class=MsoNormal>In non-verbose mode, h5diff simply prints the number of
differences in the files.<span style='mso-spacerun:yes'>  </span>Non-verbose
mode removes the need for a print token, and when ph5diff is running in this
mode, each Worker task will simply report back the number of differences it
found to the Manager task, instead of buffering them and waiting for a print token.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Other print modes:</p>

<p class=MsoNormal>Other print modes, such as printing only up to a certain
number of differences or printing only if the number of differences is greater
than some number will be implemented by notifying the Worker tasks of the
printing policy associated with the dataset.<span style='mso-spacerun:yes'> 
</span>The Worker tasks will then print accordingly.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<h1>Protocol between the Manager and Workers<span style='font-size:12.0pt;
font-family:"Times New Roman"'><o:p></o:p></span></h1>

<p class=MsoNormal>Manager computes set of datasets to diff.<span
style='mso-spacerun:yes'>  </span>If this set has more than one item, the
Manager sends an MPI_TAG_PARALLEL message to all the Workers.<span
style='mso-spacerun:yes'>  </span>The payload of this message contains the
filenames that are going to be diff’ed.<span style='mso-spacerun:yes'> 
</span>If the set contains only one item, the Manager sends a MPI_TAG_SINGLE
message to all the Workers. </p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The Workers initially lie in wait for either the
MPI_TAG_PARALLEL or MPI_TAG_SINGLE message.<span style='mso-spacerun:yes'> 
</span>Upon receipt of MPI_TAG_PARALLEL the Workers open the two filenames
provided and proceed to wait for an MPI_TAG_ARGS message.<span
style='mso-spacerun:yes'>  </span>Upon receipt of a MPI_TAG_SINGLE, the Worker
tasks gracefully exits.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>If there are datasets to diff, at this point all the Workers
are blocked waiting to receive an MPI_TAG_ARGS message which will contain the
names of the datasets to diff and the options for the diff.<span
style='mso-spacerun:yes'>  </span>The Manager maintains a list of the status of
all the Workers (which are all initially free) and proceeds to distribute
datasets for diffing to them. Once a Worker task receives an MPI_TAG_ARGS, it <span
class=GramE>proceeds</span> to diff the two datasets.<span
style='mso-spacerun:yes'>  </span>Then, it sends either an MPI_TAG_DONE or an
MPI_TAG_TOK_REQUEST message back to the Manager.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>If there are busy tasks, the Manager periodically checks for
responses from them.<span style='mso-spacerun:yes'>  </span>If all the tasks
are busy, the Manager blocks waiting for a response.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The response can be either MPI_TAG_DONE, signifying that the
Worker task has finished diffing the dataset and is ready to receive another
MPI_TAG_ARGS message, or PI_TAG_TOK_REQUEST.<span style='mso-spacerun:yes'> 
</span>The payload of MPI_TAG_DONE is the number of differences found in the
dataset.<span style='mso-spacerun:yes'>  </span>Upon receipt of an
MPI_TAG_DONE, the Manager marks that task as free and will eventually, if there
is more work available, give that task another pair of datasets to diff.<span
style='mso-spacerun:yes'>  </span>Upon receipt of an MPI_TAG_TOK_REQUEST, the
Manager checks to see if he has the token.<span style='mso-spacerun:yes'> 
</span>If so, then the Manager sends this token to the task that requested it
in a MPI_TAG_PRINT_TOK message and marks <span class=GramE>himself</span> as
not in possession of the print token.<span style='mso-spacerun:yes'> 
</span>The Manager will proceed to periodically check for an MPI_TAG_TOK_RETURN,
which signifies that the Worker task has finished printing and is ready for an
MPI_TAG_ARGS message.<span style='mso-spacerun:yes'>  </span>The payload of the
MPI_TAG_TOK_RETURN message is the number of differences found in the dataset.<span
style='mso-spacerun:yes'>  </span>If the Manager receives an MPI_TAG_TOK_REQUEST
but does not currently have the token, it will wait for an MPI_TAG_TOK_RETURN
before sending the Worker task an MPI_TAG_PRINT_TOK.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Upon completion of all the diffs of the datasets, the
Manager will send an MPI_TAG_END to all of the Worker tasks.<span
style='mso-spacerun:yes'>  </span>This will tell the Worker tasks to gracefully
exit.<span style='mso-spacerun:yes'>  </span>The Manager then exits himself.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<h1>PH5DIFF Protocol Definitions</h1>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>MPI tags are used to implement the protocol.<span
style='mso-spacerun:yes'>  </span>The tag definitions follow:</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='margin-left:.5in;text-indent:-.5in'>MPI_TAG_ARGS<span
style='mso-spacerun:yes'>            </span><span style='mso-tab-count:1'>   </span><br>
Sent by the Manager to the Worker tasks.<span style='mso-spacerun:yes'> 
</span>It contains the dataset and options for the diff call that they need to
make.</p>

<p class=MsoNormal style='margin-left:.5in;text-indent:-.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='margin-left:.5in;text-indent:-.5in'>MPI_TAG_PRINT_TOK<br>
Send by the Manager to a Worker task.<span style='mso-spacerun:yes'> 
</span>This tells the task that they have the print token and can proceed to
print their output.</p>

<p class=MsoNormal style='margin-left:.5in;text-indent:-.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='margin-left:.5in;text-indent:-.5in'>MPI_TAG_TOK_REQUEST<br>
Sent by the Worker to the Manager.<span style='mso-spacerun:yes'>  </span>This
is a request for a print token.</p>

<p class=MsoNormal style='margin-left:.5in;text-indent:-.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='margin-left:.5in;text-indent:-.5in'>MPI_TAG_DONE<br>
Sent by the Worker to the Manager.<span style='mso-spacerun:yes'>  </span>This
informs the Manager that the Worker has finished diffing the dataset AND
doesn't need to print anything and is ready to receive another piece of work.</p>

<p class=MsoNormal style='margin-left:.5in;text-indent:-.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='margin-left:.5in;text-indent:-.5in'><span
class=GramE>MPI_TAG_TOK_RETURN<br>
Send by the Worker to the Manager.</span><span style='mso-spacerun:yes'> 
</span>This informs the Manager that the Worker has finished printing their
output and is returning the print token.<span style='mso-spacerun:yes'> 
</span>It signifies that they are ready to receive another piece of work.</p>

<p class=MsoNormal style='margin-left:.5in;text-indent:-.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='margin-left:.5in;text-indent:-.5in'>MPI_TAG_END<br>
Send by the Manager to tell the Workers that all the datasets have been diff'ed
and that the Workers can exit.</p>

<p class=MsoNormal style='margin-left:.5in;text-indent:-.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='margin-left:.5in;text-indent:-.5in'>MPI_TAG_PARALLEL<br>
Sent by the Manager to tell the Workers that a parallel diff is about to
start.<span style='mso-spacerun:yes'>  </span>This tag also carries a payload
which provides the Workers with the filenames that need to be diff’ed so that
the Workers can open them.</p>

<p class=MsoNormal style='margin-left:.5in;text-indent:-.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='margin-left:.5in;text-indent:-.5in'>MPI_TAG_SINGLE<br>
<span class=GramE>Sent</span> by the Manager to tell the Workers that their
services will not be required for this diff and they can all exit.</p>

<p class=MsoNormal style='margin-left:.5in;text-indent:-.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

</div>

<div style='mso-element:footnote-list'><![if !supportFootnotes]><br clear=all>

<hr align=left size=1 width="33%">

<![endif]>

<div style='mso-element:footnote' id=ftn1>

<p class=MsoFootnoteText><a style='mso-footnote-id:ftn1' href="#_ftnref1"
name="_ftn1" title=""><span class=MsoFootnoteReference><span style='mso-special-character:
footnote'><![if !supportFootnotes]><span class=MsoFootnoteReference><span
style='font-size:10.0pt;font-family:"Times New Roman";mso-fareast-font-family:
SimSun;mso-ansi-language:EN-US;mso-fareast-language:ZH-CN;mso-bidi-language:
AR-SA'>[1]</span></span><![endif]></span></span></a> Design specification of
the Parallel HDF5 Diff Tool.</p>

</div>

</div>

</body>

</html>
